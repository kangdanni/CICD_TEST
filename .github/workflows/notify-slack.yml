name: Notify Slack on push

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ë ¤ë©´ ìµœì†Œ 2ê°œ í•„ìš”)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2) Slackìœ¼ë¡œ ë³´ë‚¼ ë©”ì‹œì§€ ë§Œë“¤ê¸° + ì „ì†¡
      - name: Send message to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # GitHub ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì»¤ë°‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref }}"


          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ë§Œ ì¶œë ¥ (íŒŒì¼ëª…ë§Œ)
          FILES=$(git diff --name-only HEAD~1 HEAD || echo "no previous commit")

          # GitHub ë¹„êµ ë§í¬ (ì—¬ëŸ¬ ì»¤ë°‹ì´ í•œ ë²ˆì— í‘¸ì‹œë˜ì—ˆì„ ë•Œ ì „ì²´ diff ë³´ëŠ” ë§í¬)
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          COMPARE_URL="https://github.com/${REPO}/compare/${BEFORE}...${AFTER}"

          TEXT="ğŸ“¦ *New push on* \`${REPO}\` (\`${BRANCH}\`)
          
          *Commit:*
          ${COMMIT_MSG} (by *${COMMIT_AUTHOR}*)
          <${COMMIT_URL}|View commit on GitHub>

          
          *Changed files:*
          \`\`\`
          ${FILES}
          \`\`\`

          <${COMPARE_URL}|View full changes on GitHub>"

          payload=$(jq -n --arg t "$TEXT" '{text: $t}')

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"
